<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kitaplar - Akƒ±llƒ± K√ºt√ºphane</title>
    <link rel="stylesheet" href="static/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">üìö Akƒ±llƒ± K√ºt√ºphane</div>
            <nav>
                <ul>
                    <li><a href="dashboard.html">Dashboard</a></li>
                    <li><a href="books.html">Kitaplar</a></li>
                    <li><a href="my-books.html">√ñd√ºn√ß Kitaplarƒ±m</a></li>
                    <li><a href="profile.html">Hesabƒ±m</a></li>
                    <li class="admin-link hidden"><a href="admin.html">Admin Panel</a></li>
                    <li><a href="#" onclick="logout(); return false;">√áƒ±kƒ±≈ü</a></li>
                </ul>
            </nav>
            <div class="user-info">
                <span class="user-info-text"></span>
            </div>
        </div>
    </header>

    <div class="container">
        <h1 style="margin: 30px 0;">Kitaplar</h1>

        <div class="card">
            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                <input type="text" id="searchInput" placeholder="Kitap adƒ± ara..." style="flex: 1; min-width: 200px;">
                <select id="categoryFilter" style="min-width: 150px;">
                    <option value="">T√ºm Kategoriler</option>
                </select>
                <button onclick="searchBooks()" class="btn btn-primary">Ara</button>
                <button onclick="loadBooks()" class="btn btn-secondary">Temizle</button>
                <button class="btn btn-success admin-link hidden" onclick="showAddBookModal()">Kitap Ekle</button>
            </div>

            <div id="booksContainer">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Y√ºkleniyor...</p>
                </div>
            </div>
        </div>
    </div>

    <div id="addBookModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addBookModal')">&times;</span>
            <h2>Yeni Kitap Ekle</h2>
            <form id="addBookForm">
                <div class="form-group">
                    <label>Ba≈ülƒ±k *</label>
                    <input type="text" id="bookBaslik" required>
                </div>
                <div class="form-group">
                    <label>ISBN</label>
                    <input type="text" id="bookISBN">
                </div>
                <div class="form-group">
                    <label>Yayƒ±n Yƒ±lƒ±</label>
                    <input type="number" id="bookYayinYili">
                </div>
                <div class="form-group">
                    <label>Toplam Kopya Sayƒ±sƒ± *</label>
                    <input type="number" id="bookToplamKopya" required min="1">
                </div>
                <div class="form-group">
                    <label>Kategori</label>
                    <select id="bookKategori"></select>
                </div>
                <div class="form-group">
                    <label>Yayƒ±n Evi</label>
                    <input type="text" id="bookYayinEvi">
                </div>
                <div class="form-group">
                    <label>A√ßƒ±klama</label>
                    <textarea id="bookAciklama" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Ekle</button>
            </form>
        </div>
    </div>

    <div id="reviewModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeModal('reviewModal')">&times;</span>
            <h2 id="reviewModalTitle">Kitap Yorumlarƒ±</h2>

            <div class="review-form-container" style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h4>Puan Ver & Yorum Yap</h4>
                <form id="addReviewForm">
                    <input type="hidden" id="reviewBookId">
                    <div class="rating-select" style="margin-bottom: 10px;">
                        <label>Puan:</label>
                        <select id="reviewRating" required style="padding: 5px;">
                            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5)</option>
                            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (4)</option>
                            <option value="3">‚≠ê‚≠ê‚≠ê (3)</option>
                            <option value="2">‚≠ê‚≠ê (2)</option>
                            <option value="1">‚≠ê (1)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <textarea id="reviewText" rows="3" placeholder="Yorumunuzu buraya yazƒ±n..." style="width: 100%; padding: 8px;"></textarea>
                    </div>
                    <button type="submit" class="btn btn-success btn-sm">G√∂nder</button>
                </form>
            </div>

            <div id="reviewsList" style="max-height: 400px; overflow-y: auto;">
            </div>
        </div>
    </div>

    <script src="static/js/api.js"></script>
    <script src="static/js/auth.js"></script>
    <script>
        let categories = [];

        document.addEventListener('DOMContentLoaded', async function() {
            const token = api.getToken();
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            const user = api.getUser();
            if (user && user.rol === 'Admin') {
                document.querySelectorAll('.admin-link').forEach(el => el.classList.remove('hidden'));
            }

            updateUserInfo(user);
            await loadCategories();
            await loadBooks();
        });

        async function loadCategories() {
            try {
                const result = await categoryAPI.getAll();
                categories = result.categories;
                const categoryFilter = document.getElementById('categoryFilter');
                const bookKategori = document.getElementById('bookKategori');

                categories.forEach(cat => {
                    const option1 = document.createElement('option');
                    option1.value = cat.kategoriID;
                    option1.textContent = cat.kategoriAdi;
                    categoryFilter.appendChild(option1);

                    const option2 = document.createElement('option');
                    option2.value = cat.kategoriID;
                    option2.textContent = cat.kategoriAdi;
                    bookKategori.appendChild(option2);
                });
            } catch (error) {
                console.error('Kategoriler y√ºklenirken hata:', error);
            }
        }

        async function loadBooks() {
            try {
                const container = document.getElementById('booksContainer');
                container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Y√ºkleniyor...</p></div>';

                const result = await bookAPI.getAll({ include_authors: 'true' });
                displayBooks(result.books);
            } catch (error) {
                console.error('Kitaplar y√ºklenirken hata:', error);
                showAlert('Kitaplar y√ºklenirken bir hata olu≈ütu', 'danger');
            }
        }

        function displayBooks(books) {
            const container = document.getElementById('booksContainer');
            if (books.length === 0) {
                container.innerHTML = '<p>Kitap bulunamadƒ±.</p>';
                return;
            }

            const user = api.getUser();
            const isAdmin = user && user.rol === 'Admin';

            container.innerHTML = `
                <div class="grid">
                    ${books.map(book => {
                        const isAvailable = book.mevcutKopyaSayisi > 0;
                        let actionButtons = '';

                        if (isAdmin) {
                            actionButtons = `
                                <button onclick="editBook(${book.kitapID})" class="btn btn-warning">D√ºzenle</button>
                                <button onclick="deleteBook(${book.kitapID})" class="btn btn-danger">Sil</button>
                            `;
                        } else {
                            if (isAvailable) {
                                actionButtons = `<button onclick="borrowBook(${book.kitapID})" class="btn btn-primary">√ñd√ºn√ß Al</button>`;
                            } else {
                                actionButtons = `<button onclick="reserveBook(${book.kitapID})" class="btn btn-warning">Sƒ±raya Gir</button>`;
                            }
                        }

                        // Yorum Butonu
                        actionButtons += `
                            <button onclick="openReviews(${book.kitapID}, '${book.baslik}')" class="btn btn-info" style="background-color: #17a2b8; color: white;">Yorumlar</button>
                        `;

                        // FAVORƒ∞ BUTONU (YENƒ∞)
                        let favButton = `
                            <button onclick="addToFavorites(${book.kitapID})" class="btn btn-outline-danger" title="Favorilere Ekle" style="margin-top:5px; border-color: #dc3545; color: #dc3545; background: white;">
                                <i class="fas fa-heart"></i>
                            </button>
                        `;

                        return `
                        <div class="book-card">
                            <div style="display:flex; justify-content:space-between; align-items:start;">
                                <h3>${book.baslik}</h3>
                                ${favButton}
                            </div>

                            <p class="author">${book.yazarlar && book.yazarlar.length > 0
                                ? book.yazarlar.map(y => `${y.ad} ${y.soyad}`).join(', ')
                                : 'Yazar bilgisi yok'}</p>
                            <p><strong>ISBN:</strong> ${book.isbn || '-'}</p>
                            <p><strong>Kategori:</strong> ${book.kategoriAdi || '-'}</p>
                            <p><strong>Mevcut Kopya:</strong> ${book.mevcutKopyaSayisi}</p>

                            <span class="status ${isAvailable ? 'status-available' : 'status-unavailable'}">
                                ${isAvailable ? 'M√ºsait' : 'T√ºkendi'}
                            </span>

                            <div style="margin-top: 15px; display: flex; gap: 5px; flex-wrap: wrap;">
                                ${actionButtons}
                            </div>
                        </div>
                    `}).join('')}
                </div>
            `;
        }

        async function searchBooks() {
            const title = document.getElementById('searchInput').value;
            const categoryId = document.getElementById('categoryFilter').value;
            try {
                const params = { include_authors: 'true' };
                if (title) params.title = title;
                if (categoryId) params.category_id = categoryId;
                const result = await bookAPI.getAll(params);
                displayBooks(result.books);
            } catch (error) {
                showAlert('Arama hatasƒ±', 'danger');
            }
        }

        // --- FAVORƒ∞ EKLEME FONKSƒ∞YONU (YENƒ∞) ---
        async function addToFavorites(bookId) {
            try {
                // api.js'de generic bir request fonksiyonu kullandƒ±ƒüƒ±nƒ±zƒ± varsayƒ±yorum (fetchWithAuth)
                const response = await fetchWithAuth(`/user/favorites/${bookId}`, {
                    method: 'POST'
                });

                if (response.success) {
                    showAlert('Kitap favorilere eklendi!', 'success');
                } else {
                    showAlert(response.message, 'warning');
                }
            } catch (error) {
                console.error('Favori hatasƒ±:', error);
                showAlert('Bir hata olu≈ütu', 'danger');
            }
        }

        async function borrowBook(bookId) {
            if (!confirm('Bu kitabƒ± √∂d√ºn√ß almak istediƒüinize emin misiniz?')) return;
            try {
                const result = await borrowAPI.borrow(bookId);
                if (result.success) {
                    showAlert('Kitap √∂d√ºn√ß alƒ±ndƒ±!', 'success');
                    await loadBooks();
                }
            } catch (error) {
                showAlert(error.message || 'Hata olu≈ütu', 'danger');
            }
        }

        async function reserveBook(bookId) {
            if (!confirm('Sƒ±raya girmek istiyor musunuz?')) return;
            try {
                const result = await reservationAPI.create({ kitapID: bookId });
                if (result.success) {
                    showAlert('Ba≈üarƒ±yla sƒ±raya girdiniz!', 'success');
                }
            } catch (error) {
                showAlert(error.message, 'danger');
            }
        }

        async function openReviews(bookId, bookTitle) {
            document.getElementById('reviewModal').style.display = 'block';
            document.getElementById('reviewModalTitle').textContent = `${bookTitle} - Yorumlar`;
            document.getElementById('reviewBookId').value = bookId;
            await loadReviews(bookId);
        }

        async function loadReviews(bookId) {
            const listContainer = document.getElementById('reviewsList');
            listContainer.innerHTML = '<p>Y√ºkleniyor...</p>';
            try {
                const result = await reviewAPI.getByBook(bookId);
                const currentUser = api.getUser();
                if (result.success && result.reviews.length > 0) {
                    listContainer.innerHTML = result.reviews.map(review => {
                        let deleteBtn = '';
                        if (currentUser && (review.kullaniciID === currentUser.kullaniciID || currentUser.rol === 'Admin')) {
                            deleteBtn = `<button onclick="deleteReview(${review.yorumID}, ${bookId})" class="btn btn-danger btn-sm" style="float:right;">Sil</button>`;
                        }
                        return `
                        <div style="border-bottom: 1px solid #eee; padding: 10px 0;">
                            <div style="display: flex; justify-content: space-between;">
                                <strong>${review.kullaniciAdi}</strong>
                                <span style="color: #f39c12;">${'‚òÖ'.repeat(review.puan)}${'‚òÜ'.repeat(5-review.puan)}</span>
                            </div>
                            <p>${review.yorum}</p>
                            <small style="color:#888;">${review.tarih}</small>
                            ${deleteBtn}
                        </div>
                        `;
                    }).join('');
                } else {
                    listContainer.innerHTML = '<p class="text-center" style="padding:20px;">Hen√ºz yorum yok.</p>';
                }
            } catch (error) {
                listContainer.innerHTML = '<p style="color:red">Hata olu≈ütu.</p>';
            }
        }

        document.getElementById('addReviewForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const bookId = document.getElementById('reviewBookId').value;
            try {
                const result = await reviewAPI.add({
                    kitapID: parseInt(bookId),
                    puan: parseInt(document.getElementById('reviewRating').value),
                    yorum: document.getElementById('reviewText').value
                });
                if (result.success) {
                    alert('Yorumunuz eklendi!');
                    document.getElementById('reviewText').value = '';
                    await loadReviews(bookId);
                } else {
                    alert(result.message);
                }
            } catch (error) {
                alert('Hata: ' + error.message);
            }
        });

        async function deleteReview(reviewId, bookId) {
            if(!confirm('Silmek istiyor musunuz?')) return;
            try {
                const result = await reviewAPI.delete(reviewId);
                if(result.success) await loadReviews(bookId);
            } catch(e) { alert(e.message); }
        }

        function showAddBookModal() { document.getElementById('addBookModal').style.display = 'block'; }
        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
        window.onclick = function(event) { if (event.target.classList.contains('modal')) event.target.style.display = 'none'; }

        document.getElementById('addBookForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const bookData = {
                baslik: document.getElementById('bookBaslik').value,
                isbn: document.getElementById('bookISBN').value,
                yayinYili: parseInt(document.getElementById('bookYayinYili').value) || null,
                toplamKopyaSayisi: parseInt(document.getElementById('bookToplamKopya').value),
                kategoriID: parseInt(document.getElementById('bookKategori').value) || null,
                yayinEvi: document.getElementById('bookYayinEvi').value,
                aciklama: document.getElementById('bookAciklama').value
            };
            try {
                const result = await bookAPI.create(bookData);
                if (result.success) {
                    showAlert('Kitap eklendi!', 'success');
                    closeModal('addBookModal');
                    document.getElementById('addBookForm').reset();
                    await loadBooks();
                }
            } catch (error) { showAlert(error.message, 'danger'); }
        });

        async function deleteBook(bookId) {
            if (!confirm('Silmek istediƒüinize emin misiniz?')) return;
            try {
                const result = await bookAPI.delete(bookId);
                if (result.success) { showAlert('Silindi!', 'success'); await loadBooks(); }
            } catch (error) { showAlert(error.message, 'danger'); }
        }
    </script>
</body>
</html>