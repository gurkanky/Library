<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kitaplar - AkÄ±llÄ± KÃ¼tÃ¼phane</title>
    <link rel="stylesheet" href="static/css/style.css">
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">ðŸ“š AkÄ±llÄ± KÃ¼tÃ¼phane</div>
            <nav>
                <ul>
                    <li><a href="dashboard.html">Dashboard</a></li>
                    <li><a href="books.html">Kitaplar</a></li>
                    <li><a href="my-books.html">Ã–dÃ¼nÃ§ KitaplarÄ±m</a></li>
                    <li class="admin-link hidden"><a href="admin.html">Admin Panel</a></li>
                    <li><a href="#" onclick="logout(); return false;">Ã‡Ä±kÄ±ÅŸ</a></li>
                </ul>
            </nav>
            <div class="user-info">
                <span class="user-info-text"></span>
            </div>
        </div>
    </header>

    <div class="container">
        <h1 style="margin: 30px 0;">Kitaplar</h1>
        
        <div class="card">
            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                <input type="text" id="searchInput" placeholder="Kitap adÄ± ara..." style="flex: 1; min-width: 200px;">
                <select id="categoryFilter" style="min-width: 150px;">
                    <option value="">TÃ¼m Kategoriler</option>
                </select>
                <button onclick="searchBooks()" class="btn btn-primary">Ara</button>
                <button onclick="loadBooks()" class="btn btn-secondary">Temizle</button>
                <button class="btn btn-success admin-link hidden" onclick="showAddBookModal()">Kitap Ekle</button>
            </div>
            
            <div id="booksContainer">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>YÃ¼kleniyor...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Book Modal -->
    <div id="addBookModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addBookModal')">&times;</span>
            <h2>Yeni Kitap Ekle</h2>
            <form id="addBookForm">
                <div class="form-group">
                    <label>BaÅŸlÄ±k *</label>
                    <input type="text" id="bookBaslik" required>
                </div>
                <div class="form-group">
                    <label>ISBN</label>
                    <input type="text" id="bookISBN">
                </div>
                <div class="form-group">
                    <label>YayÄ±n YÄ±lÄ±</label>
                    <input type="number" id="bookYayinYili">
                </div>
                <div class="form-group">
                    <label>Toplam Kopya SayÄ±sÄ± *</label>
                    <input type="number" id="bookToplamKopya" required min="1">
                </div>
                <div class="form-group">
                    <label>Kategori</label>
                    <select id="bookKategori"></select>
                </div>
                <div class="form-group">
                    <label>YayÄ±n Evi</label>
                    <input type="text" id="bookYayinEvi">
                </div>
                <div class="form-group">
                    <label>AÃ§Ä±klama</label>
                    <textarea id="bookAciklama" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Ekle</button>
            </form>
        </div>
    </div>

    <script src="static/js/api.js"></script>
    <script src="static/js/auth.js"></script>
    <script>
        let categories = [];
        
        document.addEventListener('DOMContentLoaded', async function() {
            const user = api.getUser();
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            
            if (user.rol === 'Admin') {
                document.querySelectorAll('.admin-link').forEach(el => el.classList.remove('hidden'));
            }
            
            updateUserInfo(user);
            
            await loadCategories();
            await loadBooks();
        });
        
        async function loadCategories() {
            try {
                const result = await categoryAPI.getAll();
                categories = result.categories;
                
                const categoryFilter = document.getElementById('categoryFilter');
                const bookKategori = document.getElementById('bookKategori');
                
                categories.forEach(cat => {
                    const option1 = document.createElement('option');
                    option1.value = cat.kategoriID;
                    option1.textContent = cat.kategoriAdi;
                    categoryFilter.appendChild(option1);
                    
                    const option2 = document.createElement('option');
                    option2.value = cat.kategoriID;
                    option2.textContent = cat.kategoriAdi;
                    bookKategori.appendChild(option2);
                });
            } catch (error) {
                console.error('Kategoriler yÃ¼klenirken hata:', error);
            }
        }
        
        async function loadBooks() {
            try {
                const container = document.getElementById('booksContainer');
                container.innerHTML = '<div class="loading"><div class="spinner"></div><p>YÃ¼kleniyor...</p></div>';
                
                const result = await bookAPI.getAll({ include_authors: 'true' });
                displayBooks(result.books);
            } catch (error) {
                console.error('Kitaplar yÃ¼klenirken hata:', error);
                showAlert('Kitaplar yÃ¼klenirken bir hata oluÅŸtu', 'danger');
            }
        }
        
        function displayBooks(books) {
            const container = document.getElementById('booksContainer');
            
            if (books.length === 0) {
                container.innerHTML = '<p>Kitap bulunamadÄ±.</p>';
                return;
            }
            
            const user = api.getUser();
            const isAdmin = user && user.rol === 'Admin';
            
            container.innerHTML = `
                <div class="grid">
                    ${books.map(book => `
                        <div class="book-card">
                            <h3>${book.baslik}</h3>
                            <p class="author">${book.yazarlar && book.yazarlar.length > 0 
                                ? book.yazarlar.map(y => `${y.ad} ${y.soyad}`).join(', ')
                                : 'Yazar bilgisi yok'}</p>
                            <p><strong>ISBN:</strong> ${book.isbn || '-'}</p>
                            <p><strong>Kategori:</strong> ${book.kategoriAdi || '-'}</p>
                            <p><strong>Mevcut Kopya:</strong> ${book.mevcutKopyaSayisi}</p>
                            <span class="status ${book.mevcutKopyaSayisi > 0 ? 'status-available' : 'status-unavailable'}">
                                ${book.mevcutKopyaSayisi > 0 ? 'MÃ¼sait' : 'MÃ¼sait DeÄŸil'}
                            </span>
                            <div style="margin-top: 15px; display: flex; gap: 10px;">
                                ${book.mevcutKopyaSayisi > 0 && !isAdmin 
                                    ? `<button onclick="borrowBook(${book.kitapID})" class="btn btn-primary">Ã–dÃ¼nÃ§ Al</button>`
                                    : ''}
                                ${isAdmin 
                                    ? `<button onclick="editBook(${book.kitapID})" class="btn btn-warning">DÃ¼zenle</button>
                                       <button onclick="deleteBook(${book.kitapID})" class="btn btn-danger">Sil</button>`
                                    : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        async function searchBooks() {
            const title = document.getElementById('searchInput').value;
            const categoryId = document.getElementById('categoryFilter').value;
            
            try {
                const params = { include_authors: 'true' };
                if (title) params.title = title;
                if (categoryId) params.category_id = categoryId;
                
                const result = await bookAPI.getAll(params);
                displayBooks(result.books);
            } catch (error) {
                console.error('Arama hatasÄ±:', error);
                showAlert('Arama yapÄ±lÄ±rken bir hata oluÅŸtu', 'danger');
            }
        }
        
        async function borrowBook(bookId) {
            if (!confirm('Bu kitabÄ± Ã¶dÃ¼nÃ§ almak istediÄŸinize emin misiniz?')) {
                return;
            }
            
            try {
                const result = await borrowAPI.borrow(bookId);
                if (result.success) {
                    showAlert('Kitap Ã¶dÃ¼nÃ§ alÄ±ndÄ±!', 'success');
                    await loadBooks();
                }
            } catch (error) {
                showAlert(error.message || 'Kitap Ã¶dÃ¼nÃ§ alÄ±nÄ±rken bir hata oluÅŸtu', 'danger');
            }
        }
        
        function showAddBookModal() {
            document.getElementById('addBookModal').style.display = 'block';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        document.getElementById('addBookForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const bookData = {
                baslik: document.getElementById('bookBaslik').value,
                isbn: document.getElementById('bookISBN').value,
                yayinYili: parseInt(document.getElementById('bookYayinYili').value) || null,
                toplamKopyaSayisi: parseInt(document.getElementById('bookToplamKopya').value),
                kategoriID: parseInt(document.getElementById('bookKategori').value) || null,
                yayinEvi: document.getElementById('bookYayinEvi').value,
                aciklama: document.getElementById('bookAciklama').value
            };
            
            try {
                const result = await bookAPI.create(bookData);
                if (result.success) {
                    showAlert('Kitap eklendi!', 'success');
                    closeModal('addBookModal');
                    document.getElementById('addBookForm').reset();
                    await loadBooks();
                }
            } catch (error) {
                showAlert(error.message || 'Kitap eklenirken bir hata oluÅŸtu', 'danger');
            }
        });
        
        async function deleteBook(bookId) {
            if (!confirm('Bu kitabÄ± silmek istediÄŸinize emin misiniz?')) {
                return;
            }
            
            try {
                const result = await bookAPI.delete(bookId);
                if (result.success) {
                    showAlert('Kitap silindi!', 'success');
                    await loadBooks();
                }
            } catch (error) {
                showAlert(error.message || 'Kitap silinirken bir hata oluÅŸtu', 'danger');
            }
        }
        
        // Modal dÄ±ÅŸÄ±na tÄ±klanÄ±nca kapat
        window.onclick = function(event) {
            const modal = document.getElementById('addBookModal');
            if (event.target == modal) {
                closeModal('addBookModal');
            }
        }
    </script>
</body>
</html>

