<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ã–dÃ¼nÃ§ KitaplarÄ±m - AkÄ±llÄ± KÃ¼tÃ¼phane</title>
    <link rel="stylesheet" href="static/css/style.css">
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">ðŸ“š AkÄ±llÄ± KÃ¼tÃ¼phane</div>
            <nav>
                <ul>
                    <li><a href="dashboard.html">Dashboard</a></li>
                    <li><a href="books.html">Kitaplar</a></li>
                    <li><a href="my-books.html">Ã–dÃ¼nÃ§ KitaplarÄ±m</a></li>
                    <li class="admin-link hidden"><a href="admin.html">Admin Panel</a></li>
                    <li><a href="#" onclick="logout(); return false;">Ã‡Ä±kÄ±ÅŸ</a></li>
                </ul>
            </nav>
            <div class="user-info">
                <span class="user-info-text"></span>
            </div>
        </div>
    </header>

    <div class="container">
        <h1 style="margin: 30px 0;">Ã–dÃ¼nÃ§ KitaplarÄ±m</h1>

        <div class="card">
            <h2 class="card-header">Aktif Ã–dÃ¼nÃ§ler</h2>
            <div id="activeBorrows">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>YÃ¼kleniyor...</p>
                </div>
            </div>
        </div>

        <div class="card">
            <h2 class="card-header">Ceza Bilgileri</h2>
            <div id="penaltiesContainer">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>YÃ¼kleniyor...</p>
                </div>
            </div>
        </div>

        <div class="card">
            <h2 class="card-header">GeÃ§miÅŸ Ä°ÅŸlemler</h2>
            <div id="historyBorrows">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>YÃ¼kleniyor...</p>
                </div>
            </div>
        </div>

        <div class="card mt-5">
            <h2 class="card-header">RezervasyonlarÄ±m (SÄ±rada Beklediklerim)</h2>
            <div id="reservations-list" class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Kitap</th>
                            <th>Rezervasyon Tarihi</th>
                            <th>Durum</th>
                        </tr>
                    </thead>
                    <tbody id="reservations-body">
                        <tr><td colspan="3">YÃ¼kleniyor...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="static/js/api.js"></script>
    <script src="static/js/auth.js"></script>
    <script src="static/js/token_check.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // 1. Token kontrolÃ¼
            const tokenCheck = checkTokenExpiry();

            if (!tokenCheck.valid) {
                console.warn('Token geÃ§ersiz:', tokenCheck.reason);
                if (tokenCheck.expired) {
                    alert('Oturum sÃ¼reniz dolmuÅŸ. LÃ¼tfen tekrar giriÅŸ yapÄ±n.');
                }
                window.location.href = 'login.html';
                return;
            }

            const user = api.getUser();
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            // 2. ArayÃ¼zÃ¼ gÃ¼ncelle
            if (user.rol === 'Admin') {
                document.querySelectorAll('.admin-link').forEach(el => el.classList.remove('hidden'));
            }
            updateUserInfo(user);

            // 3. Verileri YÃ¼kle
            await loadMyBooks();
            await loadPenalties();
            await loadReservations();
        });

        async function loadMyBooks() {
            const activeContainer = document.getElementById('activeBorrows');
            const historyContainer = document.getElementById('historyBorrows');

            try {
                const result = await borrowAPI.getMyBooks();

                if (!result || !result.success) {
                    throw new Error(result?.message || 'Veri alÄ±namadÄ±');
                }

                const borrows = result.borrows || [];
                const active = borrows.filter(b => b.durum === 'Aktif');
                const history = borrows.filter(b => b.durum === 'IadeEdildi');

                displayBorrows(active, 'activeBorrows', true);
                displayBorrows(history, 'historyBorrows', false);
            } catch (error) {
                console.error('Hata:', error);
                activeContainer.innerHTML = '<p>KayÄ±t bulunamadÄ± veya yÃ¼klenirken hata oluÅŸtu.</p>';
                historyContainer.innerHTML = '<p>-</p>';
            }
        }

        function displayBorrows(borrows, containerId, showReturnButton) {
            const container = document.getElementById(containerId);

            if (!borrows || borrows.length === 0) {
                container.innerHTML = '<p>KayÄ±t bulunamadÄ±.</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'table'; // CSS sÄ±nÄ±fÄ± eklendi
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Kitap</th>
                        <th>Ã–dÃ¼nÃ§ Tarihi</th>
                        <th>Son Teslim</th>
                        <th>Durum</th>
                        ${showReturnButton ? '<th>Ä°ÅŸlem</th>' : ''}
                    </tr>
                </thead>
                <tbody>
                    ${borrows.map(borrow => `
                        <tr>
                            <td>${borrow.kitap ? borrow.kitap.baslik : 'Bilinmiyor'}</td>
                            <td>${new Date(borrow.oduncAlmaTarihi).toLocaleDateString('tr-TR')}</td>
                            <td>${new Date(borrow.beklenenIadeTarihi).toLocaleDateString('tr-TR')}</td>
                            <td>
                                <span class="badge ${borrow.durum === 'Aktif' ? 'badge-success' : 'badge-secondary'}">
                                    ${borrow.durum}
                                </span>
                                ${borrow.gecikmeGunu > 0 ? `<br><small style="color:red">(${borrow.gecikmeGunu} gÃ¼n gecikme)</small>` : ''}
                            </td>
                            ${showReturnButton ? `
                                <td>
                                    <button onclick="returnBook(${borrow.oduncID})" class="btn btn-sm btn-primary">Ä°ade Et</button>
                                </td>
                            ` : ''}
                        </tr>
                    `).join('')}
                </tbody>
            `;

            container.innerHTML = '';
            container.appendChild(table);
        }

        async function returnBook(borrowId) {
            if (!confirm('Bu kitabÄ± iade etmek istediÄŸinize emin misiniz?')) {
                return;
            }
            try {
                const result = await borrowAPI.returnBook(borrowId);
                if (result.success) {
                    alert('Kitap baÅŸarÄ±yla iade edildi.');
                    await loadMyBooks();
                    await loadPenalties();
                } else {
                    alert('Hata: ' + result.message);
                }
            } catch (error) {
                alert('Ä°ÅŸlem sÄ±rasÄ±nda hata oluÅŸtu.');
            }
        }

        async function loadPenalties() {
            const container = document.getElementById('penaltiesContainer');
            try {
                // EÄŸer userAPI.getPenalties fonksiyonu endpoint'i yanlÄ±ÅŸsa 404 dÃ¶nebilir, kontrol edin.
                const result = await userAPI.getPenalties();

                if (!result || !result.success || !result.penalties || result.penalties.length === 0) {
                    container.innerHTML = '<p>Bekleyen cezanÄ±z yok.</p>';
                    return;
                }

                const pending = result.penalties.filter(p => p.durum === 'Beklemede');
                 if (pending.length === 0) {
                    container.innerHTML = '<p>Bekleyen cezanÄ±z yok.</p>';
                    return;
                }

                container.innerHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Neden</th>
                                <th>Tutar</th>
                                <th>Tarih</th>
                                <th>Ä°ÅŸlem</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${pending.map(p => `
                                <tr>
                                    <td>${p.cezaNedeni || p.aciklama || 'Gecikme'}</td>
                                    <td>${p.cezaMiktari || p.tutar} TL</td>
                                    <td>${new Date(p.olusturmaTarihi).toLocaleDateString('tr-TR')}</td>
                                    <td><button onclick="payPenalty(${p.cezaID})" class="btn btn-sm btn-success">Ã–de</button></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.warn('Ceza yÃ¼kleme hatasÄ±:', error);
                container.innerHTML = '<p>Cezalar yÃ¼klenemedi.</p>';
            }
        }

        async function payPenalty(id) {
            if(confirm('CezayÄ± Ã¶demek istiyor musunuz?')) {
                try {
                    await userAPI.payPenalty(id);
                    alert('Ã–deme baÅŸarÄ±lÄ±');
                    loadPenalties();
                } catch(e) {
                    alert('Hata oluÅŸtu');
                }
            }
        }

        async function loadReservations() {
            const tbody = document.getElementById('reservations-body');
            try {
                const result = await reservationAPI.getMyReservations();
                if (result.success && result.reservations && result.reservations.length > 0) {
                    tbody.innerHTML = result.reservations.map(res => `
                        <tr>
                            <td>${res.kitap ? res.kitap.baslik : 'Kitap'}</td>
                            <td>${new Date(res.rezervasyonTarihi).toLocaleDateString('tr-TR')}</td>
                            <td>${res.durum}</td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align:center">Aktif rezervasyonunuz yok.</td></tr>';
                }
            } catch (error) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center">YÃ¼klenemedi.</td></tr>';
            }
        }
    </script>
</body>
</html>