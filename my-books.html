<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ã–dÃ¼nÃ§ KitaplarÄ±m - AkÄ±llÄ± KÃ¼tÃ¼phane</title>
    <link rel="stylesheet" href="static/css/style.css">
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">ðŸ“š AkÄ±llÄ± KÃ¼tÃ¼phane</div>
            <nav>
                <ul>
                    <li><a href="dashboard.html">Dashboard</a></li>
                    <li><a href="books.html">Kitaplar</a></li>
                    <li><a href="my-books.html">Ã–dÃ¼nÃ§ KitaplarÄ±m</a></li>
                    <li class="admin-link hidden"><a href="admin.html">Admin Panel</a></li>
                    <li><a href="#" onclick="logout(); return false;">Ã‡Ä±kÄ±ÅŸ</a></li>
                </ul>
            </nav>
            <div class="user-info">
                <span class="user-info-text"></span>
            </div>
        </div>
    </header>

    <div class="container">
        <h1 style="margin: 30px 0;">Ã–dÃ¼nÃ§ KitaplarÄ±m</h1>
        
        <div class="card">
            <h2 class="card-header">Aktif Ã–dÃ¼nÃ§ler</h2>
            <div id="activeBorrows">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>YÃ¼kleniyor...</p>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2 class="card-header">Ceza Bilgileri</h2>
            <div id="penaltiesContainer">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>YÃ¼kleniyor...</p>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2 class="card-header">GeÃ§miÅŸ Ä°ÅŸlemler</h2>
            <div id="historyBorrows">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>YÃ¼kleniyor...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="static/js/api.js"></script>
    <script src="static/js/auth.js"></script>
    <script src="static/js/token_check.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // Token kontrolÃ¼
            const tokenCheck = checkTokenExpiry();
            console.log('Token KontrolÃ¼:', tokenCheck);
            
            if (!tokenCheck.valid) {
                console.error('Token geÃ§ersiz:', tokenCheck.reason);
                if (tokenCheck.expired) {
                    alert('Oturum sÃ¼reniz dolmuÅŸ. LÃ¼tfen tekrar giriÅŸ yapÄ±n.');
                }
                window.location.href = 'login.html';
                return;
            }
            
            const token = api.getToken();
            if (!token) {
                console.warn('Token bulunamadÄ±, login sayfasÄ±na yÃ¶nlendiriliyor');
                window.location.href = 'login.html';
                return;
            }
            
            const user = api.getUser();
            if (!user) {
                console.warn('KullanÄ±cÄ± bilgisi bulunamadÄ±, login sayfasÄ±na yÃ¶nlendiriliyor');
                window.location.href = 'login.html';
                return;
            }
            
            console.log('Token geÃ§erli, kullanÄ±cÄ±:', user);
            
            if (user.rol === 'Admin') {
                document.querySelectorAll('.admin-link').forEach(el => el.classList.remove('hidden'));
            }
            
            updateUserInfo(user);
            
            await loadMyBooks();
            await loadPenalties();
        });
        
        async function loadMyBooks() {
            const activeContainer = document.getElementById('activeBorrows');
            const historyContainer = document.getElementById('historyBorrows');
            
            try {
                const result = await borrowAPI.getMyBooks();
                
                if (!result) {
                    activeContainer.innerHTML = '<p>Veri alÄ±namadÄ±.</p>';
                    historyContainer.innerHTML = '<p>Veri alÄ±namadÄ±.</p>';
                    return;
                }
                
                if (!result.success) {
                    activeContainer.innerHTML = `<p style="color: orange;">${result.message || 'Veri alÄ±namadÄ±'}</p>`;
                    historyContainer.innerHTML = '<p>Veri yÃ¼klenemedi.</p>';
                    return;
                }
                
                const borrows = result.borrows || [];
                const active = borrows.filter(b => b.durum === 'Aktif');
                const history = borrows.filter(b => b.durum === 'IadeEdildi');
                
                displayBorrows(active, 'activeBorrows', true);
                displayBorrows(history, 'historyBorrows', false);
            } catch (error) {
                console.error('Ã–dÃ¼nÃ§ kitaplar yÃ¼klenirken hata:', error);
                const errorMsg = error.message || 'Veriler yÃ¼klenirken bir hata oluÅŸtu';
                // E-posta hatasÄ± ise kullanÄ±cÄ±ya gÃ¶sterme, sadece log'a yaz
                if (errorMsg.includes('Subject') || errorMsg.includes('email') || errorMsg.includes('mail')) {
                    console.warn('E-posta hatasÄ± (gÃ¶rmezden geliniyor):', errorMsg);
                    activeContainer.innerHTML = '<p>KayÄ±t bulunamadÄ±.</p>';
                    historyContainer.innerHTML = '<p>KayÄ±t bulunamadÄ±.</p>';
                } else {
                    activeContainer.innerHTML = `<p style="color: red;">Hata: ${errorMsg}</p>`;
                    historyContainer.innerHTML = '<p>Veri yÃ¼klenemedi.</p>';
                    showAlert('Veriler yÃ¼klenirken bir hata oluÅŸtu: ' + errorMsg, 'danger');
                }
            }
        }
        
        function displayBorrows(borrows, containerId, showReturnButton) {
            const container = document.getElementById(containerId);
            
            if (borrows.length === 0) {
                container.innerHTML = '<p>KayÄ±t bulunamadÄ±.</p>';
                return;
            }
            
            const table = document.createElement('table');
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Kitap</th>
                        <th>Ã–dÃ¼nÃ§ Tarihi</th>
                        <th>Beklenen Ä°ade</th>
                        <th>Durum</th>
                        ${showReturnButton ? '<th>Ä°ÅŸlem</th>' : ''}
                    </tr>
                </thead>
                <tbody>
                    ${borrows.map(borrow => `
                        <tr>
                            <td>${borrow.kitap ? borrow.kitap.baslik : 'Bilinmiyor'}</td>
                            <td>${new Date(borrow.oduncAlmaTarihi).toLocaleDateString('tr-TR')}</td>
                            <td>${new Date(borrow.beklenenIadeTarihi).toLocaleDateString('tr-TR')}</td>
                            <td>
                                <span class="badge ${borrow.durum === 'Aktif' ? 'badge-success' : 'badge-warning'}">
                                    ${borrow.durum}
                                </span>
                                ${borrow.gecikmeGunu > 0 ? `<span class="badge badge-danger">${borrow.gecikmeGunu} gÃ¼n gecikme</span>` : ''}
                            </td>
                            ${showReturnButton ? `
                                <td>
                                    <button onclick="returnBook(${borrow.oduncID})" class="btn btn-primary">Ä°ade Et</button>
                                </td>
                            ` : ''}
                        </tr>
                    `).join('')}
                </tbody>
            `;
            
            container.innerHTML = '';
            container.appendChild(table);
        }
        
        async function returnBook(borrowId) {
            if (!confirm('Bu kitabÄ± iade etmek istediÄŸinize emin misiniz?')) {
                return;
            }
            
            try {
                const result = await borrowAPI.returnBook(borrowId);
                if (result.success) {
                    showAlert('Kitap iade edildi!', 'success');
                    await loadMyBooks();
                    await loadPenalties();
                }
            } catch (error) {
                showAlert(error.message || 'Kitap iade edilirken bir hata oluÅŸtu', 'danger');
            }
        }
        
        async function loadPenalties() {
            const container = document.getElementById('penaltiesContainer');
            
            try {
                const result = await userAPI.getPenalties();
                
                if (!result) {
                    container.innerHTML = '<p>Veri alÄ±namadÄ±.</p>';
                    return;
                }
                
                if (!result.success) {
                    container.innerHTML = `<p style="color: orange;">${result.message || 'Veri alÄ±namadÄ±'}</p>`;
                    return;
                }
                
                const penalties = result.penalties || [];
                const pending = penalties.filter(p => p.durum === 'Beklemede');
                
                if (pending.length === 0) {
                    container.innerHTML = '<p>Bekleyen cezanÄ±z yok.</p>';
                    return;
                }
                
                const table = document.createElement('table');
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Ceza Nedeni</th>
                            <th>Miktar</th>
                            <th>Tarih</th>
                            <th>Ä°ÅŸlem</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${pending.map(penalty => `
                            <tr>
                                <td>${penalty.cezaNedeni || '-'}</td>
                                <td>${penalty.cezaMiktari ? penalty.cezaMiktari.toFixed(2) : '0.00'} TL</td>
                                <td>${penalty.olusturmaTarihi ? new Date(penalty.olusturmaTarihi).toLocaleDateString('tr-TR') : '-'}</td>
                                <td>
                                    <button onclick="payPenalty(${penalty.cezaID})" class="btn btn-success">Ã–de</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                `;
                
                container.innerHTML = '';
                container.appendChild(table);
            } catch (error) {
                console.error('Ceza bilgileri yÃ¼klenirken hata:', error);
                const errorMsg = error.message || 'Ceza bilgileri yÃ¼klenirken bir hata oluÅŸtu';
                // E-posta hatasÄ± ise kullanÄ±cÄ±ya gÃ¶sterme
                if (errorMsg.includes('Subject') || errorMsg.includes('email') || errorMsg.includes('mail')) {
                    console.warn('E-posta hatasÄ± (gÃ¶rmezden geliniyor):', errorMsg);
                    container.innerHTML = '<p>Bekleyen cezanÄ±z yok.</p>';
                } else {
                    container.innerHTML = `<p style="color: red;">Hata: ${errorMsg}</p>`;
                }
            }
        }
        
        async function payPenalty(penaltyId) {
            if (!confirm('Bu cezayÄ± Ã¶demek istediÄŸinize emin misiniz?')) {
                return;
            }
            
            try {
                const result = await userAPI.payPenalty(penaltyId);
                if (result.success) {
                    showAlert('Ceza Ã¶dendi!', 'success');
                    await loadPenalties();
                }
            } catch (error) {
                showAlert(error.message || 'Ceza Ã¶denirken bir hata oluÅŸtu', 'danger');
            }
        }
    </script>
</body>
</html>

